= Настройка модуля интеграции с {uc}

Выпуск сертификата выполняется с использованием методов API модуля. Описание API модуля приведено в разделе руководстве разработчика модуля: "xref:programmer:index.adoc[]".

Модуль использует API {uc} и требует получить доступ к Crypto API {uc}.

. Инструкция по получению доступа к Crypto API https://developer.kontur.ru/doc/crypto.api?about=2[приведена на сайте {uc}].
. Обратите внимание, что работа в продуктовой среде осуществляется по HTTPS-соединению и потребует настроить защищенный канал связи, использующий ГОСТ-криптографию. Подробности приведены по ссылке: https://disk.skbkontur.ru/index.php/s/96SaxYpsJ2xJbdd[настройка ГОСТ-TLS].
. [[password]]Для подачи заявления в ОС Windows используется приложение PkiTools (см. инструкцию из шага выше). При настройке ГОСТ-криптографии через приложение откажитесь от установки пароля:
+
WARNING: В окне установки пароля для контейнера не задавайте пароль, оставьте поле _Новый пароль_ пустым.
+
.Пароль для контейнера
image::container-password.png[Пароль для контейнера]
+
. На финальном шаге настройки по инструкции https://disk.skbkontur.ru/index.php/s/96SaxYpsJ2xJbdd[настройка ГОСТ-TLS] в приложении на сервере будет создан файл запроса и контейнер закрытого ключа. Этот файл запроса и заявление нужно отправить в {uc} по адресу, указанному на странице "https://developer.kontur.ru/doc/crypto.api?about=2[Получение доступа к Crypto API]".
+
. Полученный от КриптоПро сертификат нужно установить в контейнер закрытого ключа по инструкции https://support.kontur.ru/ca/38784-kak_ustanovit_lichnyj_sertifikat_cherez_kriptopro[Установка личного сертификата через КриптоПро CSP].
. Убедитесь, что у пользователя, для которого будет выпускаться сертификат, в карточке сотрудника указано ФИО и заполнен номер телефона в поле “Рабочий телефон”. На этот номер позже будут приходить СМС уведомления при подписании.
. Укажите значение следующих настроек в Конструкторе справочников:
+
.Заполненные настройки в конструкторе справочников
image::directory-designer.png[Заполненные настройки в конструкторе справочников]
+
[source,csharp]
----
CryptoApiConnectionAddress "https://cloudtest.kontur-ca.ru/v3/" <.>
CryptoAuthenticationCertificateThumbprint "certificate-thumbprint" <.>
KcrApiConnectionAddress "https://api.kontur.ru/kcr/" <.>
KcrApiKey "api-key" <.>
RestClientMaxTimeout "60000" <.>
----
<.> `CryptoApiConnectionAddress` -- точка подключения к КриптоПро.
<.> `CryptoAuthenticationCertificateThumbprint` -- отпечаток сертификата, переданного контуром по заявке.
<.> `KcrApiConnectionAddress` -- точка подключения к API {uc}.
<.> `KcrApiKey` -- API-ключ {uc}.
<.> `RestClientMaxTimeout` -- интервал времени (в миллисекундах), в течение которого будет ожидаться ответ от {uc}. Значение по умолчанию `60` секунд.
+
.Отпечаток сертификата
image::thumbprint.png[Отпечаток сертификата]
+
. Подайте заявку на сертификат с использованием "xref:programmer:issue-certificate.adoc[API модуля]".
. Убедитесь, что в справочнике сотрудников в карточке сотрудника указан полученный сертификат.

// [#register]
// == Регистрация сертификата
//
//
//
// [#recall]
// == Отзыв сертификата
//
//
//
// [#check]
// == Проверка сертификата

== Настройка типов подписи

По умолчанию при использовании облачного сертификата Контур УЦ формируется подпись вида CAdES-T. Поведение по умолчанию было изменено в версии {kc-v}.

Если требуется формировать подписи типа CAdES-BES, в Конструкторе справочников, в узел _Настройки модуля интеграции с УЦ Контур_, необходимо добавить строку с именем _SignType_ и описанием `0`. CAdES-T можно вернуть, если удалить строку или проставить в описании `2`.

== Запрос на сертификат Unix

При необходимости можно использовать `cryptcp` для создания запроса на сертификат. В запросе необходимо использовать только поля, требуемые в заявлении. Поля INN и OGRN необходимо указывать в виде цифровых идентификаторов `OID.1.2.643.3.131.1.1` и `OID.1.2.643.100.1` соответственно.

Пример генерации запроса для сертификата:

 cryptcp -creatrqst request.csr -provtype 80 -cont "\\\\.\HDIMAGE\TestReq" -certusage "1.3.6.1.5.5.7.3.2" -dn "CN=АО ПФ СКБ Контур, O=АО ПФ СКБ Контур, OID.1.2.643.3.131.1.1=006663003127, OID.1.2.643.100.1=1026605606620, C=RU, S=66 Свердловская область, L=Екатеринбург, STREET=ул Народной воли стр 19А, E=fake@mail.ru" -ex -ku 11
